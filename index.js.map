{"version":3,"file":"index.js","sources":["src/core.jsx"],"sourcesContent":["import React from 'react'\nimport { autorun, isObservable, toJS } from 'mobx'\nimport shallowEqual from 'fbjs/lib/shallowEqual'\n\nexport default inject => Component => class extends React.Component {\n  static contextTypes = {\n    mobxStores: () => null, // this is to avoid importing prop-types\n  }\n\n  constructor(props, context) {\n    super(props, context)\n\n    this.state = {\n      injectedProps: {},\n      props,\n    }\n\n    let firstRun = true\n    this.dispose = autorun(() => {\n      // rerun store mapping so the flat values are processed again\n      const injected = inject(this.context.mobxStores)\n\n      // copy to make sure we don't mutate an object that could be used by the injectFunction\n      const injectedProps = { ...injected }\n\n      // flatten mobx-state-tree stores\n      Object.keys(injectedProps).forEach((key) => {\n        const value = injectedProps[key]\n        if (isObservable(value)) {\n          injectedProps[key] = toJS(injectedProps[key])\n        }\n      })\n\n      // on first run we have to use this.state, not this.setState\n      if (firstRun) {\n        firstRun = false\n        this.state = { ...this.state, injectedProps }\n      } else if (!shallowEqual(injectedProps, this.state.injectedProps)) {\n        this.setState(prevState => ({ ...prevState, injectedProps }))\n      }\n    })\n  }\n\n  /* this is to make sure children component is refreshed */\n  componentWillReceiveProps(nextProps) {\n    if (shallowEqual(nextProps, this.props)) return\n    this.setState(prevState => ({ ...prevState, props: nextProps }))\n  }\n\n  /* unbind observable reaction */\n  componentWillUnmount() {\n    this.dispose()\n  }\n\n  render() {\n    return (\n      <Component\n        /* this is parent props */\n        {...this.state.props}\n        /* this is injected props from hoc */\n        {...this.state.injectedProps}\n      />\n    )\n  }\n}\n"],"names":["props","context","state","firstRun","dispose","autorun","injected","inject","_this","mobxStores","injectedProps","keys","forEach","key","value","isObservable","toJS","shallowEqual","setState","prevState","React","Component","nextProps","this","contextTypes"],"mappings":"2lCAIyB,sDAKXA,EAAOC,4EACXD,EAAOC,MAERC,qCAKDC,GAAW,WACVC,QAAUC,UAAQ,eAEfC,EAAWC,EAAOC,EAAKP,QAAQQ,YAG/BC,OAAqBJ,UAGpBK,KAAKD,GAAeE,QAAQ,SAACC,OAC5BC,EAAQJ,EAAcG,GACxBE,eAAaD,OACDD,GAAOG,OAAKN,EAAcG,OAKxCV,MACS,IACND,WAAaM,EAAKN,OAAOQ,mBACpBO,EAAaP,EAAeF,EAAKN,MAAMQ,kBAC5CQ,SAAS,wBAAmBC,GAAWT,2VAlCAU,EAAMC,gEAwC9BC,GACpBL,EAAaK,EAAWC,KAAKvB,aAC5BkB,SAAS,wBAAmBC,GAAWnB,MAAOsB,0DAK9ClB,kDAKHgB,gBAACC,OAEKE,KAAKrB,MAAMF,MAEXuB,KAAKrB,MAAMQ,2BAvDdc,yBACO,kBAAM"}